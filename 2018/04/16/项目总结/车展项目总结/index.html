<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>对一个离线版网站的项目总结 · boomler的杂记</title><meta name="description" content="对一个离线版网站的项目总结 - boomler"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/solarized-light.css"><link rel="search" type="application/opensearchdescription+xml" href="https://haowang-tw.github.io/atom.xml" title="boomler的杂记"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://avatars1.githubusercontent.com/u/3142935?v=3&amp;s=466 or file" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">分类</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">对一个离线版网站的项目总结</h1><div class="tags"><a href="/tags/离线应用/" class="tag-title">#离线应用</a><a href="/tags/cordova/" class="tag-title">#cordova</a><a href="/tags/项目总结/" class="tag-title">#项目总结</a></div><div class="post-info">Apr 16, 2018</div><div class="post-content"><p>2018年3月到4月在做一个车展项目，该项目实际上是将该公司线上购车网站转换成离线版，打包到ipad上，最终使得车展的参会者能够在iPad上体验线上购车和购买售后套餐的流程。<br>由于我们已经有了线上版本，那么把代码拷贝过来，并将数据缓存到本地上就好了。将线上数据缓存到本地是本次项目的难点。<br><a id="more"></a></p>
<h2 id="图片、视频、字体等资源"><a href="#图片、视频、字体等资源" class="headerlink" title="图片、视频、字体等资源"></a>图片、视频、字体等资源</h2><p>对于一些静态资源文件，如js、css、image等直接下载到本地，并改写路径即可。<br>使用gsed重写部分文件路径。<br>例如我们对字体进行了这样的处理，在<code>dist/static/js</code>目录下的文件中找到对字体文件的使用，将路径改掉：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gsed -i -E &apos;s#\/\w+-ec.woff#static/font\0#g&apos; dist/static/js/*.js;</span><br><span class="line">mkdir dist/static/font;</span><br><span class="line">mv dist/*-ec* dist/static/font</span><br></pre></td></tr></table></figure></p>
<h2 id="后端数据"><a href="#后端数据" class="headerlink" title="后端数据"></a>后端数据</h2><blockquote>
<p><strong> PouchDB是受 Apache CouchDB启发为Web设计的一款占用空间少的数据库。它尤其适合于需要基于浏览器的可离线使用的存储方案的移动应用。</strong></p>
</blockquote>
<p>我们的做法是在http模块加一个<strong>拦截器</strong>， 每一个请求通过时，将其url作为主键，将其返回值和状态码存储到<code>PouchDB</code>中。具体代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">this.db.put(&#123;</span><br><span class="line">    _id: request.getUrl(),  // 使用url作为id</span><br><span class="line">    response: &#123;</span><br><span class="line">    body: preProcess(response.json()),  // 存储返回值</span><br><span class="line">    options: &#123;status: response.status&#125;  // 存储http状态码</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>我们加入拦截器之后，必须设法触发所有的请求，这样才能保证<code>pouchDB</code>存储了所有的http请求。那这个工作量如何呢？</p>
<p>如果一个商品列表页面有十个商品， 那么有10个链接通往商品详情页面，如果每个商品详情页面又有3个请求去拉取该商品各部分信息。那么仅仅这两个页面就有<code>10 + 10 * 3</code>共40个不同的http请求要发出，向下面这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">get /products</span><br><span class="line">get /products/1</span><br><span class="line">get /products/2</span><br><span class="line">get /products/3</span><br><span class="line">get /products/4</span><br><span class="line">···</span><br><span class="line">get /products/10</span><br><span class="line"></span><br><span class="line">get /products/1/price</span><br><span class="line">get /products/2/price</span><br><span class="line">get /products/3/price</span><br><span class="line">get /products/4/price</span><br><span class="line">···</span><br></pre></td></tr></table></figure></p>
<p>我们发现如果想要将系统所有可能的http请求触发一遍几乎是不可能，即使强行人工去做，也可能存在遗漏。在这种情况下，我们对一些数据和接口做了处理。比如商品列表接口本来要返回200件商品，我们只返回10件商品，具体办法是将商品列表请求指向本地商品json数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getBrandClass: vue.resource(&apos;./static/data/brands&#123;/brand&#125;/all-classes.json&apos;),</span><br><span class="line">allClasses: vue.resource(&apos;./static/data/all-classes/all-classes.json&apos;),</span><br></pre></td></tr></table></figure></p>
<p><strong>更改一些接口返回的数据，使得整体的工作量可控。</strong><br>其他减小工作量的举措：</p>
<ul>
<li>车系列表中有40多种车，但只会随机跳转到两个车辆详情页面</li>
<li>无论选择购车城市在哪儿，都按照在北京处理（往后传递的参数都是北京）。</li>
<li>其他类似处理</li>
</ul>
<p>最后，pouchDB总共缓存了200+请求数据， 本地大概有十几个json数据集。</p>
<h2 id="对技术方案的思考"><a href="#对技术方案的思考" class="headerlink" title="对技术方案的思考"></a>对技术方案的思考</h2><p>在将一个网站整体静态化的过程中，使用直接缓存所有http请求的方式使得几乎不需要对代码做出更改，改代码的工作主要是去除登录验证，以及部分参数处理逻辑。<br>但http请求往往具有相关性，比如列表页返回列表项的id为[1, 2, 3]，那么详情页面使用的参数肯定是[1, 2, 3]。这样的话如果列表页面返回的数据变了，详情页等后续页面的缓存数据也就全失效了。我们的解决方案是开发过程中不去管pouchDB，还是直接使用线上数据和本地json数据集。所有的开发完成之后，并且需求不再变动之后才会让QA或其他负责人去遍历所有页面和各种http请求组合，做数据缓存的工作。</p>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>开发完成之后， 使用Cordova打成iPad上能使用的包，但有一点需要注意的是cordova使用的浏览器内核版本，低版本的内核性能较差，在列表滚动和跳转的时候感受到了明显的掉帧，最终升级内核版本解决了这个问题。</p>
<p>–END–</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/16/git-rm/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2018 <a href="https://haowang-tw.github.io">boomler</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>